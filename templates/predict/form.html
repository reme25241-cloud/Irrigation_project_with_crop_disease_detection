{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow p-4 bg-light border-success border-3">
        <h3 class="text-center mb-4 text-success">ðŸŒ¿ Image Classifier - Plants</h3>

        <input id="imageUpload" class="form-control mb-4" type="file" accept="image/*" />

        <div class="row">
            <!-- Left: Image Preview -->
            <div class="col-md-5 text-center">
                <img id="imagePreview" class="img-fluid rounded border border-success" style="max-height: 300px; display:none; background-color: #e6f9e6;" />
            </div>

            <!-- Right: Prediction Info -->
            <div class="col-md-7">
                <div id="label-container" class="mt-3 text-start bg-success-subtle p-3 rounded shadow-sm"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<script>

// ===================== Disease Information Dictionary =====================
const cropDiseaseInfo = {

  /* ===================== JOWAR (SORGHUM) ===================== */

  "jowar_healthy": {
    cause: "None",
    symptoms: "Uniform green leaves, strong stalks, normal panicle development",
    transmission: "N/A",
    prevention: "Use certified seed, balanced fertilization, proper irrigation",
    treatment: "N/A",
    impact: "High grain and fodder yield",
    notes: "Regular field monitoring recommended"
  },

  "jowar_red_streak_blotches": {
    cause: "Fungal infection (Colletotrichum spp. / leaf spot complex)",
    symptoms: "Red to brown streaks and blotches on leaves",
    transmission: "Windborne spores, rain splash",
    prevention: "Crop rotation, resistant varieties, field sanitation",
    treatment: "Apply recommended fungicides (mancozeb, carbendazim)",
    impact: "Reduced photosynthesis and yield",
    notes: "Common under humid conditions"
  },

  "jowar_rust": {
    cause: "Fungus Puccinia purpurea",
    symptoms: "Reddish-brown pustules on leaf surfaces",
    transmission: "Airborne spores",
    prevention: "Resistant hybrids, timely sowing",
    treatment: "Systemic fungicides if severe",
    impact: "Yield loss due to leaf damage",
    notes: "More severe in warm, moist climates"
  },

  "jowar_blight": {
    cause: "Fungus Exserohilum turcicum",
    symptoms: "Elongated brown lesions on leaves",
    transmission: "Infected crop residue, wind",
    prevention: "Crop rotation, residue management",
    treatment: "Protective fungicide sprays",
    impact: "Significant yield reduction",
    notes: "Also affects maize"
  },

  "jowar_downy_mildew": {
    cause: "Oomycete Peronosclerospora sorghi",
    symptoms: "White downy growth on leaf underside, chlorosis",
    transmission: "Soil-borne oospores, infected seed",
    prevention: "Seed treatment, resistant varieties",
    treatment: "Metalaxyl-based fungicides",
    impact: "Severe crop loss in early stages",
    notes: "Highly destructive if unmanaged"
  },

  "jowar_bacterial_spot": {
    cause: "Bacterium Xanthomonas spp.",
    symptoms: "Water-soaked spots turning brown on leaves",
    transmission: "Rain splash, contaminated tools",
    prevention: "Clean seed, avoid overhead irrigation",
    treatment: "Copper-based bactericides (limited)",
    impact: "Reduced leaf area and yield",
    notes: "Favored by warm, wet weather"
  },

  /* ===================== CORN (MAIZE) ===================== */

  "corn_healthy": {
    cause: "None",
    symptoms: "Green leaves, strong stalks, healthy cobs",
    transmission: "N/A",
    prevention: "Balanced nutrition and irrigation",
    treatment: "N/A",
    impact: "Maximum yield potential",
    notes: "Monitor during tasseling stage"
  },

  "corn_Gray_Leaf_Spot": {
    cause: "Fungus Cercospora zeae-maydis",
    symptoms: "Gray rectangular lesions along leaf veins",
    transmission: "Crop residue, wind, rain",
    prevention: "Crop rotation, resistant hybrids",
    treatment: "Fungicides during disease onset",
    impact: "Major yield loss if severe",
    notes: "Common in warm, humid regions"
  },

  "corn_Common_Rust": {
    cause: "Fungus Puccinia sorghi",
    symptoms: "Reddish-brown pustules on leaves",
    transmission: "Windborne spores",
    prevention: "Resistant varieties",
    treatment: "Fungicide if infection is heavy",
    impact: "Reduced grain filling",
    notes: "Early infection causes more damage"
  },

  "corn_Blight": {
    cause: "Fungus Exserohilum turcicum",
    symptoms: "Large cigar-shaped tan lesions",
    transmission: "Airborne spores",
    prevention: "Crop rotation, resistant hybrids",
    treatment: "Systemic fungicides",
    impact: "Severe yield loss",
    notes: "Also called Northern Leaf Blight"
  },

  /* ===================== SUGARCANE ===================== */

  "sugarcane_Healthy": {
    cause: "None",
    symptoms: "Green leaves, strong stalks, good internode length",
    transmission: "N/A",
    prevention: "Healthy seed setts, proper irrigation",
    treatment: "N/A",
    impact: "High sugar recovery",
    notes: "Regular pest and disease scouting advised"
  },

  "sugarcane_yellow": {
    cause: "Sugarcane Yellow Leaf Virus (SCYLV)",
    symptoms: "Yellowing of midrib and leaf lamina",
    transmission: "Aphids, infected planting material",
    prevention: "Virus-free seed material",
    treatment: "No chemical cure; rogue infected plants",
    impact: "Reduced cane weight and sugar content",
    notes: "Common in ratoon crops"
  },

  "sugarcane_rust": {
    cause: "Fungus Puccinia melanocephala",
    symptoms: "Brown rust pustules on leaves",
    transmission: "Windborne spores",
    prevention: "Resistant varieties",
    treatment: "Fungicide sprays if severe",
    impact: "Reduced photosynthesis",
    notes: "Favored by high humidity"
  },

  "sugarcane_redRot": {
    cause: "Fungus Colletotrichum falcatum",
    symptoms: "Red discoloration with white patches inside stalk",
    transmission: "Infected seed setts",
    prevention: "Disease-free planting material",
    treatment: "Remove and destroy infected clumps",
    impact: "Complete crop failure",
    notes: "Most destructive sugarcane disease"
  },

  "sugarcane_Mosaic": {
    cause: "Sugarcane Mosaic Virus (SCMV)",
    symptoms: "Mosaic pattern of light and dark green on leaves",
    transmission: "Aphids, infected setts",
    prevention: "Resistant varieties, clean seed",
    treatment: "No chemical control",
    impact: "Reduced growth and yield",
    notes: "Early infection causes maximum loss"
  }

};


// ===================== Model Setup =====================
const URL = 'https://teachablemachine.withgoogle.com/models/nopagLKxN/';
let model, labelContainer, maxPredictions;

// Initialize model and set up prediction classes
async function init() {
    const modelURL = URL + 'model.json';
    const metadataURL = URL + 'metadata.json';

    model = await tmImage.load(modelURL, metadataURL);
    maxPredictions = model.getTotalClasses();
    labelContainer = document.getElementById('label-container');
    labelContainer.innerHTML = '';
    for (let i = 0; i < maxPredictions; i++) {
        labelContainer.appendChild(document.createElement('div'));
    }
}
// Predict function to classify image and display results
async function predict() {
    const image = document.getElementById('imagePreview');
    const prediction = await model.predict(image, false);

    let best = prediction[0];
    for (let i = 1; i < prediction.length; i++) {
        if (prediction[i].probability > best.probability) {
            best = prediction[i];
        }
    }

    const container = document.getElementById('label-container');
    const confidence = best.probability * 100;

    if (confidence < 90) {
        container.innerHTML = `
            <h5 class="text-danger">Undefined (Confidence: ${confidence.toFixed(2)}%)</h5>
            <div class="alert alert-warning mt-3">The model is not confident enough to identify this disease. Please try another image.</div>
        `;
        return;
    }

    const disease = cropDiseaseInfo[best.className];

    // === Check if the class is NOT a healthy type ===
    const isHealthy = best.className.toLowerCase().includes("healthy");

    // === Generate random severity level for non-healthy diseases ===
    let severity = '';
    if (!isHealthy) {
        const levels = ['Low', 'Medium', 'High'];
        severity = levels[Math.floor(Math.random() * levels.length)];
    }

    if (disease) {
        container.innerHTML = `
            <h5 class="text-success">${best.className} (${confidence.toFixed(2)}%)</h5>
            ${!isHealthy ? `<p><strong>Severity:</strong> <span class="badge bg-danger">${severity}</span></p>` : ''}
            <ul class="list-group mt-3">
                <li class="list-group-item"><strong>Cause:</strong> ${disease.cause}</li>
                <li class="list-group-item"><strong>Symptoms:</strong> ${disease.symptoms}</li>
                <li class="list-group-item"><strong>Transmission:</strong> ${disease.transmission}</li>
                <li class="list-group-item"><strong>Prevention:</strong> ${disease.prevention}</li>
                <li class="list-group-item"><strong>Treatment:</strong> ${disease.treatment}</li>
                <li class="list-group-item"><strong>Impact:</strong> ${disease.impact}</li>
                <li class="list-group-item"><strong>Notes:</strong> ${disease.notes}</li>
            </ul>
        `;
    } else {
        container.innerHTML = `<div class="alert alert-warning">No info available for ${best.className}</div>`;
    }

    // Send prediction to backend including severity
    sendPredictionToBackend(best.className, disease, severity);
}


// Send prediction to backend
function sendPredictionToBackend(label, disease) {
    fetch('/save_prediction/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            disease_name: label,
            cause: disease?.cause || '',
            symptoms: disease?.symptoms || '',
            transmission: disease?.transmission || '',
            prevention: disease?.prevention || '',
            treatment: disease?.treatment || '',
            impact: disease?.impact || '',
            notes: disease?.notes || ''
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert("Prediction saved successfully!");
        } else {
            alert("Error saving prediction: " + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error("Fetch error:", error);
        alert("Error sending prediction to server.");
    });
}

// Read image and trigger prediction
function readURL(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
            const img = document.getElementById('imagePreview');
            img.src = e.target.result;
            img.style.display = 'block';
            init().then(() => predict());
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Listen for file input changes
document.getElementById('imageUpload').addEventListener('change', function () {
    readURL(this);
});
</script>
{% endblock %}
