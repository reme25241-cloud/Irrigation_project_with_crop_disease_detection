{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow p-4 bg-light border-success border-3">
        <h3 class="text-center mb-4 text-success">ðŸŒ¿ Live Plant Disease Detection</h3>

        <!-- Camera Controls -->
        <div class="text-center mb-3">
            <button id="startCamera" class="btn btn-success me-2">ðŸ“· Start Camera</button>
            <button id="stopCamera" class="btn btn-danger">â›” Stop Camera</button>
        </div>

        <!-- Webcam -->
        <div class="text-center">
            <video id="webcam"
                   autoplay
                   playsinline
                   class="img-fluid rounded border border-success"
                   style="max-height:320px; display:none; background:#e6f9e6;">
            </video>
        </div>

        <!-- Prediction Output -->
        <div class="mt-4">
            <div id="label-container"
                 class="bg-success-subtle p-3 rounded shadow-sm">
                <p class="text-muted text-center">Start the camera to begin detection</p>
            </div>
        </div>
    </div>
</div>

<!-- TensorFlow + Teachable Machine -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<script>
// =======================================================
// Disease Information Dictionary (UNCHANGED)
// =======================================================
// ===================== Disease Information Dictionary =====================
const cropDiseaseInfo = {

  /* ===================== JOWAR (SORGHUM) ===================== */

  "jowar_healthy": {
    cause: "None",
    symptoms: "Uniform green leaves, strong stalks, normal panicle development",
    transmission: "N/A",
    prevention: "Use certified seed, balanced fertilization, proper irrigation",
    treatment: "N/A",
    impact: "High grain and fodder yield",
    notes: "Regular field monitoring recommended"
  },

  "jowar_red_streak_blotches": {
    cause: "Fungal infection (Colletotrichum spp. / leaf spot complex)",
    symptoms: "Red to brown streaks and blotches on leaves",
    transmission: "Windborne spores, rain splash",
    prevention: "Crop rotation, resistant varieties, field sanitation",
    treatment: "Apply recommended fungicides (mancozeb, carbendazim)",
    impact: "Reduced photosynthesis and yield",
    notes: "Common under humid conditions"
  },

  "jowar_rust": {
    cause: "Fungus Puccinia purpurea",
    symptoms: "Reddish-brown pustules on leaf surfaces",
    transmission: "Airborne spores",
    prevention: "Resistant hybrids, timely sowing",
    treatment: "Systemic fungicides if severe",
    impact: "Yield loss due to leaf damage",
    notes: "More severe in warm, moist climates"
  },

  "jowar_blight": {
    cause: "Fungus Exserohilum turcicum",
    symptoms: "Elongated brown lesions on leaves",
    transmission: "Infected crop residue, wind",
    prevention: "Crop rotation, residue management",
    treatment: "Protective fungicide sprays",
    impact: "Significant yield reduction",
    notes: "Also affects maize"
  },

  "jowar_downy_mildew": {
    cause: "Oomycete Peronosclerospora sorghi",
    symptoms: "White downy growth on leaf underside, chlorosis",
    transmission: "Soil-borne oospores, infected seed",
    prevention: "Seed treatment, resistant varieties",
    treatment: "Metalaxyl-based fungicides",
    impact: "Severe crop loss in early stages",
    notes: "Highly destructive if unmanaged"
  },

  "jowar_bacterial_spot": {
    cause: "Bacterium Xanthomonas spp.",
    symptoms: "Water-soaked spots turning brown on leaves",
    transmission: "Rain splash, contaminated tools",
    prevention: "Clean seed, avoid overhead irrigation",
    treatment: "Copper-based bactericides (limited)",
    impact: "Reduced leaf area and yield",
    notes: "Favored by warm, wet weather"
  },

  /* ===================== CORN (MAIZE) ===================== */

  "corn_healthy": {
    cause: "None",
    symptoms: "Green leaves, strong stalks, healthy cobs",
    transmission: "N/A",
    prevention: "Balanced nutrition and irrigation",
    treatment: "N/A",
    impact: "Maximum yield potential",
    notes: "Monitor during tasseling stage"
  },

  "corn_Gray_Leaf_Spot": {
    cause: "Fungus Cercospora zeae-maydis",
    symptoms: "Gray rectangular lesions along leaf veins",
    transmission: "Crop residue, wind, rain",
    prevention: "Crop rotation, resistant hybrids",
    treatment: "Fungicides during disease onset",
    impact: "Major yield loss if severe",
    notes: "Common in warm, humid regions"
  },

  "corn_Common_Rust": {
    cause: "Fungus Puccinia sorghi",
    symptoms: "Reddish-brown pustules on leaves",
    transmission: "Windborne spores",
    prevention: "Resistant varieties",
    treatment: "Fungicide if infection is heavy",
    impact: "Reduced grain filling",
    notes: "Early infection causes more damage"
  },

  "corn_Blight": {
    cause: "Fungus Exserohilum turcicum",
    symptoms: "Large cigar-shaped tan lesions",
    transmission: "Airborne spores",
    prevention: "Crop rotation, resistant hybrids",
    treatment: "Systemic fungicides",
    impact: "Severe yield loss",
    notes: "Also called Northern Leaf Blight"
  },

  /* ===================== SUGARCANE ===================== */

  "sugarcane_Healthy": {
    cause: "None",
    symptoms: "Green leaves, strong stalks, good internode length",
    transmission: "N/A",
    prevention: "Healthy seed setts, proper irrigation",
    treatment: "N/A",
    impact: "High sugar recovery",
    notes: "Regular pest and disease scouting advised"
  },

  "sugarcane_yellow": {
    cause: "Sugarcane Yellow Leaf Virus (SCYLV)",
    symptoms: "Yellowing of midrib and leaf lamina",
    transmission: "Aphids, infected planting material",
    prevention: "Virus-free seed material",
    treatment: "No chemical cure; rogue infected plants",
    impact: "Reduced cane weight and sugar content",
    notes: "Common in ratoon crops"
  },

  "sugarcane_rust": {
    cause: "Fungus Puccinia melanocephala",
    symptoms: "Brown rust pustules on leaves",
    transmission: "Windborne spores",
    prevention: "Resistant varieties",
    treatment: "Fungicide sprays if severe",
    impact: "Reduced photosynthesis",
    notes: "Favored by high humidity"
  },

  "sugarcane_redRot": {
    cause: "Fungus Colletotrichum falcatum",
    symptoms: "Red discoloration with white patches inside stalk",
    transmission: "Infected seed setts",
    prevention: "Disease-free planting material",
    treatment: "Remove and destroy infected clumps",
    impact: "Complete crop failure",
    notes: "Most destructive sugarcane disease"
  },

  "sugarcane_Mosaic": {
    cause: "Sugarcane Mosaic Virus (SCMV)",
    symptoms: "Mosaic pattern of light and dark green on leaves",
    transmission: "Aphids, infected setts",
    prevention: "Resistant varieties, clean seed",
    treatment: "No chemical control",
    impact: "Reduced growth and yield",
    notes: "Early infection causes maximum loss"
  }

};

// =======================================================
// Model Setup
// =======================================================
const MODEL_URL = 'https://teachablemachine.withgoogle.com/models/nopagLKxN/';
let model;
let webcamStream = null;
let isCameraRunning = false;

const webcamElement = document.getElementById("webcam");
const labelContainer = document.getElementById("label-container");

// Load Model
async function initModel() {
    model = await tmImage.load(
        MODEL_URL + "model.json",
        MODEL_URL + "metadata.json"
    );
}

// =======================================================
// Camera Control
// =======================================================
async function startCamera() {
    if (isCameraRunning) return;

    await initModel();

    webcamStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
        audio: false
    });

    webcamElement.srcObject = webcamStream;
    webcamElement.style.display = "block";
    isCameraRunning = true;

    predictionLoop();
}

function stopCamera() {
    if (webcamStream) {
        webcamStream.getTracks().forEach(track => track.stop());
    }
    webcamElement.style.display = "none";
    labelContainer.innerHTML = `<p class="text-muted text-center">Camera stopped</p>`;
    isCameraRunning = false;
}

// =======================================================
// Prediction Loop
// =======================================================
async function predictionLoop() {
    if (!isCameraRunning) return;

    const predictions = await model.predict(webcamElement, false);
    const best = predictions.reduce((a, b) =>
        a.probability > b.probability ? a : b
    );

    const confidence = (best.probability * 100).toFixed(2);
    const disease = cropDiseaseInfo[best.className];
    const isHealthy = best.className.toLowerCase().includes("healthy");

    if (confidence < 90) {
        labelContainer.innerHTML = `
            <h5 class="text-warning text-center">Scanningâ€¦ (${confidence}%)</h5>
            <p class="text-center text-muted">Hold camera steady</p>
        `;
    } else if (disease) {
        labelContainer.innerHTML = `
            <h5 class="text-success">${best.className} (${confidence}%)</h5>
            ${!isHealthy ? `<span class="badge bg-danger mb-2">Disease Detected</span>` : ''}
            <ul class="list-group mt-2">
                <li class="list-group-item"><strong>Cause:</strong> ${disease.cause}</li>
                <li class="list-group-item"><strong>Symptoms:</strong> ${disease.symptoms}</li>
                <li class="list-group-item"><strong>Prevention:</strong> ${disease.prevention}</li>
                <li class="list-group-item"><strong>Treatment:</strong> ${disease.treatment}</li>
                <li class="list-group-item"><strong>Impact:</strong> ${disease.impact}</li>
            </ul>
        `;
    }

    requestAnimationFrame(predictionLoop);
}

// =======================================================
// Events
// =======================================================
document.getElementById("startCamera").addEventListener("click", startCamera);
document.getElementById("stopCamera").addEventListener("click", stopCamera);
</script>
{% endblock %}
